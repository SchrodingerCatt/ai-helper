<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini áƒ©áƒáƒ¢áƒ‘áƒáƒ¢áƒ˜áƒ¡ áƒ˜áƒœáƒ¢áƒ”áƒ áƒ¤áƒ”áƒ˜áƒ¡áƒ˜</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* áƒ¤áƒáƒœáƒ¢áƒ˜áƒ¡ áƒ™áƒáƒœáƒ¤áƒ˜áƒ’áƒ£áƒ áƒáƒªáƒ˜áƒ áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡ */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Georgian:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans Georgian', sans-serif;
            background-color: #f4f7f9;
        }
        /* Custom scrollbar for chat history */
        #chat-history::-webkit-scrollbar {
            width: 8px;
        }
        #chat-history::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* slate-300 */
            border-radius: 4px;
        }
        #chat-history::-webkit-scrollbar-track {
            background-color: #f1f5f9; /* slate-100 */
        }
        .user-message {
            background-color: #10b981; /* emerald-500 */
            color: white;
        }
        .ai-message {
            background-color: #ffffff;
            color: #1f2937; /* gray-800 */
            border: 1px solid #e5e7eb; /* gray-200 */
        }
    </style>
</head>
<body class="flex flex-col h-screen antialiased">

    <div class="flex flex-col h-full max-w-4xl mx-auto w-full p-4">
        
        <header class="text-center mb-6 py-3 border-b border-gray-300">
            <h1 class="text-3xl font-bold text-gray-800">ğŸ¤– Gemini áƒ©áƒáƒ¢áƒ‘áƒáƒ¢áƒ˜</h1>
            <p class="text-sm text-gray-500 mt-1">áƒ“áƒáƒ™áƒáƒ•áƒ¨áƒ˜áƒ áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ áƒ—áƒ¥áƒ•áƒ”áƒœáƒ¡ FastAPI áƒ¡áƒ”áƒ áƒ•áƒ”áƒ áƒ—áƒáƒœ</p>
        </header>

        <div id="chat-history" class="flex-grow overflow-y-auto space-y-4 p-4 mb-4 bg-white rounded-xl shadow-lg border border-gray-100">
            <div class="flex justify-start">
                <div class="ai-message p-3 rounded-t-xl rounded-br-xl max-w-xs md:max-w-md shadow">
                    áƒ’áƒáƒ›áƒáƒ áƒ¯áƒáƒ‘áƒ! áƒ›áƒ” áƒ•áƒáƒ  áƒ—áƒ¥áƒ•áƒ”áƒœáƒ˜ áƒáƒ¡áƒ˜áƒ¡áƒ¢áƒ”áƒœáƒ¢áƒ˜. áƒ›áƒ™áƒ˜áƒ—áƒ®áƒ”áƒ— áƒ áƒáƒª áƒ’áƒ¡áƒ£áƒ áƒ—.
                </div>
            </div>
        </div>

        <div class="flex-shrink-0">
            <form id="chat-form" class="flex items-center space-x-3 p-4 bg-white rounded-xl shadow-2xl">
                
                <input
                    type="text"
                    id="user-prompt"
                    placeholder="áƒ©áƒáƒ¬áƒ”áƒ áƒ”áƒ— áƒ—áƒ¥áƒ•áƒ”áƒœáƒ˜ áƒ¨áƒ”áƒ™áƒ˜áƒ—áƒ®áƒ•áƒ áƒáƒ¥..."
                    class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 transition duration-150"
                    required
                />
                
                <button
                    type="submit"
                    id="send-button"
                    class="px-6 py-3 bg-emerald-600 text-white font-semibold rounded-lg shadow-md hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 transition duration-150 flex items-center justify-center"
                >
                    <span id="button-text">áƒ’áƒáƒ’áƒ–áƒáƒ•áƒœáƒ</span>
                    <svg id="loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </form>
        </div>

        <div class="text-xs text-gray-400 text-center mt-3">
            <p>API Key-áƒ¡ áƒáƒ•áƒ¢áƒáƒ áƒ˜áƒ–áƒáƒªáƒ˜áƒ áƒ®áƒ“áƒ”áƒ‘áƒ áƒ¡áƒ”áƒ áƒ•áƒ”áƒ áƒ–áƒ”. áƒ’áƒáƒ¡áƒáƒ¦áƒ”áƒ‘áƒ˜ áƒáƒ¦áƒáƒ  áƒáƒ áƒ˜áƒ¡ áƒ®áƒ˜áƒšáƒ£áƒšáƒ˜ áƒ¤áƒ áƒáƒœáƒ¢áƒ”áƒœáƒ“áƒ¨áƒ˜.</p>
        </div>
    </div>

    <script>
        // --- áƒ™áƒáƒœáƒ¤áƒ˜áƒ’áƒ£áƒ áƒáƒªáƒ˜áƒ ---
        // LOCAL_API_KEY áƒáƒ›áƒáƒ¦áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ áƒ£áƒ¡áƒáƒ¤áƒ áƒ—áƒ®áƒáƒ”áƒ‘áƒ˜áƒ¡ áƒ›áƒ˜áƒ–áƒœáƒ˜áƒ—. 
        // áƒ”áƒœáƒ“áƒáƒáƒ˜áƒœáƒ¢áƒ˜ Render-áƒ–áƒ” áƒ’áƒáƒ¨áƒ•áƒ”áƒ‘áƒ˜áƒ¡áƒáƒ¡: 
        // áƒ—áƒ£ HTML áƒ¤áƒáƒ˜áƒšáƒ¡ FastAPI áƒ”áƒ›áƒ¡áƒáƒ®áƒ£áƒ áƒ”áƒ‘áƒ, áƒ¡áƒáƒ™áƒ›áƒáƒ áƒ˜áƒ¡áƒ˜áƒ áƒ¤áƒáƒ áƒ“áƒáƒ‘áƒ˜áƒ—áƒ˜ URL-áƒ˜áƒ¡ áƒ›áƒ˜áƒ—áƒ˜áƒ—áƒ”áƒ‘áƒ.
        const API_ENDPOINT = "/process_query"; 
        
        // áƒ’áƒšáƒáƒ‘áƒáƒšáƒ£áƒ áƒ˜ áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒšáƒ˜áƒ¡ ID
        const USER_ID = `user-${Math.random().toString(36).substring(2, 9)}`;

        // DOM áƒ”áƒšáƒ”áƒ›áƒ”áƒœáƒ¢áƒ”áƒ‘áƒ˜
        const chatForm = document.getElementById('chat-form');
        const userPromptInput = document.getElementById('user-prompt');
        const chatHistory = document.getElementById('chat-history');
        const sendButton = document.getElementById('send-button');
        const buttonText = document.getElementById('button-text');
        const loadingSpinner = document.getElementById('loading-spinner');

        // --- áƒ“áƒáƒ›áƒ®áƒ›áƒáƒ áƒ” áƒ¤áƒ£áƒœáƒ¥áƒªáƒ˜áƒ”áƒ‘áƒ˜ ---

        /**
         * áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ¡ áƒ¨áƒ”áƒ¢áƒ§áƒáƒ‘áƒ˜áƒœáƒ”áƒ‘áƒáƒ¡ áƒ©áƒáƒ¢áƒ˜áƒ¡ áƒ˜áƒ¡áƒ¢áƒáƒ áƒ˜áƒáƒ¡.
         * @param {string} message - áƒ¨áƒ”áƒ¢áƒ§áƒáƒ‘áƒ˜áƒœáƒ”áƒ‘áƒ˜áƒ¡ áƒ¢áƒ”áƒ¥áƒ¡áƒ¢áƒ˜.
         * @param {string} sender - áƒ’áƒáƒ›áƒ’áƒ–áƒáƒ•áƒœáƒ˜ ('user' áƒáƒœ 'ai').
         */
        function addMessage(message, sender) {
            const messageContainer = document.createElement('div');
            const messageBubble = document.createElement('div');

            // áƒ¨áƒ”áƒ¢áƒ§áƒáƒ‘áƒ˜áƒœáƒ”áƒ‘áƒ˜áƒ¡ áƒ™áƒáƒœáƒ¢áƒ”áƒ˜áƒœáƒ”áƒ áƒ˜áƒ¡ áƒ¡áƒ¢áƒ˜áƒšáƒ˜áƒ–áƒáƒªáƒ˜áƒ
            messageContainer.className = sender === 'user' ? 'flex justify-end' : 'flex justify-start';
            
            // áƒ¨áƒ”áƒ¢áƒ§áƒáƒ‘áƒ˜áƒœáƒ”áƒ‘áƒ˜áƒ¡ áƒ‘áƒáƒ‘áƒšáƒ˜áƒ¡ áƒ¡áƒ¢áƒ˜áƒšáƒ˜áƒ–áƒáƒªáƒ˜áƒ
            messageBubble.className = `${sender === 'user' ? 'user-message' : 'ai-message'} p-3 rounded-xl max-w-xs md:max-w-md shadow whitespace-pre-wrap`;
            
            // áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒšáƒ˜áƒ¡ áƒ¨áƒ”áƒ¢áƒ§áƒáƒ‘áƒ˜áƒœáƒ”áƒ‘áƒ”áƒ‘áƒ˜áƒ¡ áƒ¡áƒáƒ”áƒªáƒ˜áƒáƒšáƒ£áƒ áƒ˜ áƒ“áƒáƒ›áƒ áƒ’áƒ•áƒáƒšáƒ”áƒ‘áƒ
            if (sender === 'user') {
                messageBubble.classList.add('rounded-tr-none');
            } else {
                messageBubble.classList.add('rounded-tl-none');
            }

            messageBubble.innerText = message;
            messageContainer.appendChild(messageBubble);
            chatHistory.appendChild(messageContainer);
            
            // áƒ¡áƒ¥áƒ áƒáƒšáƒ˜áƒ áƒ”áƒ‘áƒ áƒ‘áƒáƒšáƒáƒ›áƒ“áƒ”
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        /**
         * áƒáƒ©áƒ•áƒ”áƒœáƒ”áƒ‘áƒ¡/áƒ›áƒáƒšáƒáƒ•áƒ¡ áƒ©áƒáƒ¢áƒ•áƒ˜áƒ áƒ—áƒ•áƒ˜áƒ¡ áƒ˜áƒœáƒ“áƒ˜áƒ™áƒáƒ¢áƒáƒ áƒ¡ áƒ“áƒ áƒ‘áƒšáƒáƒ™áƒáƒ•áƒ¡ áƒ¦áƒ˜áƒšáƒáƒ™áƒ¡.
         * @param {boolean} isLoading - áƒ©áƒáƒ¢áƒ•áƒ˜áƒ áƒ—áƒ•áƒ áƒ›áƒ˜áƒ›áƒ“áƒ˜áƒœáƒáƒ áƒ”áƒáƒ‘áƒ¡ áƒ—áƒ£ áƒáƒ áƒ.
         */
        function setLoadingState(isLoading) {
            sendButton.disabled = isLoading;
            if (isLoading) {
                buttonText.classList.add('hidden');
                loadingSpinner.classList.remove('hidden');
                sendButton.classList.add('opacity-75', 'cursor-not-allowed');
            } else {
                buttonText.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
                sendButton.classList.remove('opacity-75', 'cursor-not-allowed');
            }
        }

        // --- áƒ›áƒ—áƒáƒ•áƒáƒ áƒ˜ áƒšáƒáƒ’áƒ˜áƒ™áƒ ---

        /**
         * áƒáƒ›áƒ£áƒ¨áƒáƒ•áƒ”áƒ‘áƒ¡ áƒ¤áƒáƒ áƒ›áƒ˜áƒ¡ áƒ’áƒáƒ’áƒ–áƒáƒ•áƒœáƒáƒ¡.
         * @param {Event} event - áƒ¤áƒáƒ áƒ›áƒ˜áƒ¡ áƒ›áƒáƒ•áƒšáƒ”áƒœáƒ.
         */
        async function handleChatSubmit(event) {
            event.preventDefault(); 

            const prompt = userPromptInput.value.trim();
            if (!prompt) return;

            // 1. áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒšáƒ˜áƒ¡ áƒ¨áƒ”áƒ¢áƒ§áƒáƒ‘áƒ˜áƒœáƒ”áƒ‘áƒ˜áƒ¡ áƒ©áƒ•áƒ”áƒœáƒ”áƒ‘áƒ
            addMessage(prompt, 'user');
            userPromptInput.value = ''; 
            setLoadingState(true);

            // 2. áƒ›áƒáƒ—áƒ®áƒáƒ•áƒœáƒ˜áƒ¡ áƒ›áƒáƒœáƒáƒªáƒ”áƒ›áƒ”áƒ‘áƒ˜
            const requestPayload = {
                prompt: prompt,
                user_id: USER_ID
            };

            // 3. API-áƒ¡ áƒ’áƒáƒ›áƒáƒ«áƒáƒ®áƒ”áƒ‘áƒ
            try {
                const maxRetries = 3;
                let apiResponse = null;

                for (let attempt = 0; attempt < maxRetries; attempt++) {
                    try {
                        const response = await fetch(API_ENDPOINT, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                // 'X-API-Key' áƒáƒ¦áƒáƒ  áƒ˜áƒ’áƒ–áƒáƒ•áƒœáƒ”áƒ‘áƒ
                            },
                            body: JSON.stringify(requestPayload)
                        });
                        
                        if (!response.ok) {
                             if (response.status >= 500 && attempt < maxRetries - 1) {
                                throw new Error('Retryable Server Error');
                             }

                             const errorDetails = await response.json();
                             throw new Error(`API áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ: ${response.status} - ${errorDetails.detail || 'áƒ¡áƒ”áƒ áƒ•áƒ”áƒ áƒ˜áƒ¡ áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ'}`);
                        }

                        apiResponse = await response.json();
                        break; 

                    } catch (e) {
                        if (e.message === 'Retryable Server Error' && attempt < maxRetries - 1) {
                            const waitTime = Math.pow(2, attempt) * 1000;
                            await new Promise(resolve => setTimeout(resolve, waitTime));
                        } else if (attempt === maxRetries - 1) {
                            throw e;
                        } else {
                            throw e;
                        }
                    }
                }
                
                if (!apiResponse) {
                     throw new Error('áƒáƒáƒ¡áƒ£áƒ®áƒ˜ áƒ•áƒ”áƒ  áƒ›áƒ˜áƒ˜áƒ¦áƒ”áƒ¡ áƒ’áƒáƒœáƒ›áƒ”áƒáƒ áƒ”áƒ‘áƒ˜áƒ—áƒ˜ áƒªáƒ“áƒ”áƒ‘áƒ˜áƒ¡ áƒ¨áƒ”áƒ›áƒ“áƒ”áƒ’.');
                }

                // 4. AI áƒáƒáƒ¡áƒ£áƒ®áƒ˜áƒ¡ áƒ©áƒ•áƒ”áƒœáƒ”áƒ‘áƒ
                if (apiResponse.status === 'success') {
                    addMessage(apiResponse.ai_response, 'ai');
                } else {
                    addMessage(`áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ AI-áƒ¡áƒ’áƒáƒœ: ${apiResponse.ai_response || 'áƒáƒáƒ¡áƒ£áƒ®áƒ˜ áƒ•áƒ”áƒ  áƒ›áƒ˜áƒ˜áƒ¦áƒ”áƒ¡.'}`, 'ai');
                }

            } catch (error) {
                console.error("Fetch áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ:", error);
                // áƒ—áƒ£ áƒšáƒáƒ™áƒáƒšáƒ£áƒ áƒáƒ“ áƒ®áƒáƒ áƒ—, áƒ¨áƒ”áƒ˜áƒ«áƒšáƒ”áƒ‘áƒ áƒ“áƒáƒ’áƒ­áƒ˜áƒ áƒ“áƒ”áƒ— API_ENDPOINT-áƒ˜áƒ¡ áƒ¨áƒ”áƒªáƒ•áƒšáƒ 
                // Render-áƒ˜áƒ¡ URL-áƒ˜áƒ— áƒáƒœ 'http://localhost:8080/process_query'-áƒ˜áƒ—
                addMessage(`âŒ áƒ‘áƒáƒ“áƒ˜áƒ¨áƒ˜, áƒ™áƒáƒ•áƒ¨áƒ˜áƒ áƒ˜ áƒ¨áƒ”áƒ¬áƒ§áƒ“áƒ: ${error.message}. áƒ“áƒáƒ áƒ¬áƒ›áƒ£áƒœáƒ“áƒ˜áƒ—, áƒ áƒáƒ› áƒ¡áƒ”áƒ áƒ•áƒ”áƒ áƒ˜ áƒ’áƒáƒ¨áƒ•áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ!`, 'ai');
            } finally {
                setLoadingState(false);
            }
        }

        // áƒ›áƒáƒ•áƒšáƒ”áƒœáƒ˜áƒ¡ áƒ›áƒ¡áƒ›áƒ”áƒœáƒ”áƒšáƒ˜áƒ¡ áƒ›áƒ˜áƒ›áƒáƒ’áƒ áƒ”áƒ‘áƒ
        chatForm.addEventListener('submit', handleChatSubmit);

    </script>
</body>
</html>
